{% extends "base.html" %}
{% block content %}
<div class="container my-5 text-center">
    <h2 class="mb-4">{{ playlist_name }}</h2>

    {% if songs %}
        <div class="song-stack position-relative mx-auto" style="height: 500px; max-width: 400px;">
            {% for song in songs %}
          <div class="card song-card shadow-lg position-absolute top-0 start-50 translate-middle-x"
              data-track-uri="{{ song.track_uri }}"
              data-name="{{ song.name|escapejs }}"
              data-image="{{ song.image_url }}"
              data-preview="{{ song.preview_url }}"
              data-spotify="{{ song.spotify_url }}"
              data-artists="{{ song.artists|join:", "|escapejs }}"
              style="width: 100%; height: 100%; transition: all 0.3s ease; {% if not forloop.last %}z-index: {{ forloop.revcounter }};{% endif %}">
                
                <!-- Song image -->
                <img src="{{ song.image_url|default:'/static/img/placeholder.png' }}" 
                     class="card-img-top" 
                     alt="Song cover" 
                     style="height: 70%; object-fit: cover;">
                
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h4 class="card-title">{{ song.name }}</h4>

                    {% if song.artists %}
                        <p class="text-muted mb-2">
                            {{ song.artists|join:", " }}
                        </p>
                    {% endif %}

                    {% if song.preview_url %}
                        <audio controls style="width: 90%;">
                            <source src="{{ song.preview_url }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    {% endif %}

                    <div class="d-flex align-items-center mt-2">
                        <a href="{{ song.spotify_url }}" class="btn btn-outline-success">
                            ▶ Listen on Spotify
                        </a>
                    </div>

                    <button class="btn btn-primary mt-2 play-btn" data-uri="{{ song.track_uri }}">
                        ▶ Play
                    </button>
                </div>

            </div>
            {% endfor %}
        </div>

        <div class="text-center mb-3">
            <a href="{% url 'playlists.kept' playlist_id=playlist_id %}" class="btn btn-outline-secondary">View Kept</a>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons" class="d-flex justify-content-between mt-4">
            <button class="btn remove-btn" style="width: 48%; font-size: 1.5rem;">✖</button>
            <button class="btn keep-btn" style="width: 48%; font-size: 1.5rem;">✔</button>
        </div>
    {% else %}
        <p class="text-muted">No songs found in this playlist.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const stack = document.querySelector('.song-stack');
    const actionButtons = document.getElementById('action-buttons');

    function getCards() {
        const cards = stack.querySelectorAll('.song-card');
        if (cards.length === 0 && actionButtons) {
            actionButtons.style.display = 'none';
        }
        return cards;
    }

    function removeCard(card, direction = 'right') {
        card.style.transform = direction === 'right'
            ? 'translateX(500px) rotate(20deg)'
            : 'translateX(-500px) rotate(-20deg)';
        card.style.opacity = 0;
        setTimeout(() => {
            card.remove();
            getCards();
        }, 300);
    }

    const keepBtn = document.querySelector('.keep-btn');
    const removeBtn = document.querySelector('.remove-btn');
    async function saveDecisionAndRemove(card, kept) {
        // extract data from card
        const payload = {
            playlist_id: '{{ playlist_id }}',
            track_uri: card.dataset.trackUri || card.getAttribute('data-track-uri'),
            name: card.dataset.name || card.getAttribute('data-name'),
            artists: (card.dataset.artists || card.getAttribute('data-artists') || '').split(',').map(s => s.trim()).filter(Boolean),
            image_url: card.dataset.image || card.getAttribute('data-image'),
            preview_url: card.dataset.preview || card.getAttribute('data-preview'),
            spotify_url: card.dataset.spotify || card.getAttribute('data-spotify'),
            kept: kept
        };

        try {
            await fetch("{% url 'playlists.save_decision' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });
        } catch (err) {
            console.error('Failed to save decision', err);
        }

        // remove the specific card that was acted upon
        if (card) removeCard(card, kept ? 'right' : 'left');
    }

    keepBtn.addEventListener('click', () => {
        const cards = getCards();
        if (cards.length) saveDecisionAndRemove(cards[0], true);
    });

    removeBtn.addEventListener('click', () => {
        const cards = getCards();
        if (cards.length) saveDecisionAndRemove(cards[0], false);
    });

    // removed per-card 'Kept' buttons (keeps are handled from the Kept page)
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const playButtons = document.querySelectorAll('.play-btn');

    playButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const trackUri = btn.dataset.uri;

            // Use Django's url template tag to generate the endpoint dynamically
            const url = "{% url 'spotify_play_track' %}";

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // CSRF protection
                },
                body: JSON.stringify({ uri: trackUri })
            });

            if (response.ok) {
                alert('Playback started!');
            } else {
                const data = await response.json();
                alert('Failed to start playback: ' + data.message);
            }
        });
    });
});
</script>


<style>
.song-card {
    cursor: grab;
}
.song-card img {
    border-bottom: 1px solid #ddd;
}
/* Action buttons section styling */
#action-buttons {
    background: #000;
    padding: 10px;
    border-radius: 10px;
    max-width: 400px;
    margin: auto;
}

#action-buttons .keep-btn {
    background-color: #16a34a; /* green */
    color: #fff;
    border: none;
}

#action-buttons .remove-btn {
    background-color: #dc2626; /* red */
    color: #fff;
    border: none;
}

.quick-kept-btn {
    background-color: #16a34a;
    color: #fff;
    border: none;
}
</style>
{% endblock %}
