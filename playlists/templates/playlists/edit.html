{% extends "base.html" %}
{% block content %}
<div class="container my-5 text-center position-relative">
    <div class="position-absolute top-0 end-0 mt-2 me-2 d-flex gap-2">
        <a href="{% url 'playlists.edit_by_id' playlist_id=playlist_id %}?show_all=true" class="btn btn-outline-secondary btn-sm">Reset Progress</a>
        <a href="{% url 'playlists.kept' playlist_id=playlist_id %}" class="btn btn-outline-spotify btn-sm">View Choices</a>
    </div>
    <h2 class="mb-4">{{ playlist_name }}</h2>

    {% if songs %}
                <div class="song-stack position-relative mx-auto">
            {% for song in songs %}
                      <div class="card song-card position-absolute top-0 start-50 translate-middle-x"
              data-track-uri="{{ song.track_uri }}"
              data-name="{{ song.name }}"
              data-image="{{ song.image_url }}"
              data-preview="{{ song.preview_url }}"
              data-spotify="{{ song.spotify_url }}"
              data-artists="{{ song.artists|join:", " }}"
                          {% if forloop.counter > 3 %}style="display: none; z-index: {{ forloop.revcounter }};"{% else %}style="z-index: {{ forloop.revcounter }};"{% endif %}> 
                
                <!-- Song image -->
             <img src="{{ song.image_url|default:'/static/img/placeholder.png' }}" 
                 class="card-img-top" 
                 alt="Song cover">
                
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h4 class="card-title">{{ song.name }}</h4>

                    {% if song.artists %}
                        <p class="text-muted mb-2">
                            {{ song.artists|join:", " }}
                        </p>
                    {% endif %}

                    {% if song.preview_url %}
                        <audio controls style="width: 100%;">
                            <source src="{{ song.preview_url }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    {% endif %}

                    <div class="d-flex gap-2 mt-3 w-100 justify-content-center align-items-center">
                        <a href="{{ song.spotify_url }}" target="_blank" rel="noopener" class="btn btn-outline-spotify btn-sm btn-pill flex-fill">
                            <i class="fa-brands fa-spotify me-1"></i>Listen on Spotify
                        </a>
                        {% if song.preview_url %}
                        <button class="btn btn-spotify btn-sm btn-pill flex-fill play-btn" data-uri="{{ song.track_uri }}">
                            <i class="fa-solid fa-play me-1"></i>Play
                        </button>
                        {% else %}
                        <span class="no-preview-badge">No preview</span>
                        {% endif %}
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>

        

        <!-- Action Buttons -->
        <div id="action-buttons" class="d-flex mt-4 gap-3">
            <button class="btn btn-danger remove-btn flex-fill">✖ Remove</button>
            <button class="btn btn-spotify keep-btn flex-fill">✔ Keep</button>
        </div>

        <!-- Progress Tracker -->
        <div class="progress-tracker mt-4">
            <p class="text-muted">Progress: <strong><span id="processed-count">{{ processed_count }}</span> / {{ total_count }}</strong></p>
        </div>
    {% else %}
        {% if has_songs_in_playlist %}
            <p class="text-muted">No songs left in playlist to edit.</p>
        {% else %}
            <p class="text-muted">No songs found in this playlist.</p>
        {% endif %}
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const stack = document.querySelector('.song-stack');
    const actionButtons = document.getElementById('action-buttons');
    const processedCountEl = document.getElementById('processed-count');

    function getCards() {
        const cards = stack.querySelectorAll('.song-card');
        if (cards.length === 0 && actionButtons) {
            actionButtons.style.display = 'none';
        }
        return cards;
    }

    function updateProcessedCount() {
        if (processedCountEl) {
            const currentCount = parseInt(processedCountEl.textContent);
            processedCountEl.textContent = currentCount + 1;
        }
    }

    function removeCard(card, direction = 'right') {
        card.style.transform = direction === 'right'
            ? 'translateX(500px) rotate(20deg)'
            : 'translateX(-500px) rotate(-20deg)';
        card.style.opacity = 0;
        setTimeout(() => {
            card.remove();
            // Show the next hidden card if it exists
            const allCards = stack.querySelectorAll('.song-card');
            const hiddenCards = Array.from(allCards).filter(c => c.style.display === 'none');
            if (hiddenCards.length > 0) {
                hiddenCards[0].style.display = '';
            }
            getCards();
        }, 300);
    }

    const keepBtn = document.querySelector('.keep-btn');
    const removeBtn = document.querySelector('.remove-btn');
    let isProcessing = false; // Flag to prevent double-clicks

    async function saveDecisionAndRemove(card, kept) {
        // Prevent multiple clicks while processing
        if (isProcessing) return;
        isProcessing = true;

        // Disable buttons during processing
        keepBtn.disabled = true;
        removeBtn.disabled = true;

        // extract data from card
        const payload = {
            playlist_id: '{{ playlist_id }}',
            track_uri: card.dataset.trackUri || card.getAttribute('data-track-uri'),
            name: card.dataset.name || card.getAttribute('data-name'),
            artists: (card.dataset.artists || card.getAttribute('data-artists') || '').split(',').map(s => s.trim()).filter(Boolean),
            image_url: card.dataset.image || card.getAttribute('data-image'),
            preview_url: card.dataset.preview || card.getAttribute('data-preview'),
            spotify_url: card.dataset.spotify || card.getAttribute('data-spotify'),
            kept: kept
        };

        try {
            await fetch("{% url 'playlists.save_decision' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });
        } catch (err) {
            console.error('Failed to save decision', err);
        }

        // Update progress count
        updateProcessedCount();

        // remove the specific card that was acted upon
        if (card) removeCard(card, kept ? 'right' : 'left');

        // Re-enable buttons after animation completes (300ms + small buffer)
        setTimeout(() => {
            isProcessing = false;
            keepBtn.disabled = false;
            removeBtn.disabled = false;
        }, 350);
    }

    keepBtn.addEventListener('click', () => {
        const cards = getCards();
        if (cards.length) saveDecisionAndRemove(cards[0], true);
    });

    removeBtn.addEventListener('click', () => {
        const cards = getCards();
        if (cards.length) saveDecisionAndRemove(cards[0], false);
    });

    // removed per-card 'Kept' buttons (keeps are handled from the Kept page)
});
</script>

<script>
// Use HTML5 audio preview instead of Spotify device playback
document.addEventListener('DOMContentLoaded', () => {
    const playButtons = document.querySelectorAll('.play-btn');
    const allAudios = () => Array.from(document.querySelectorAll('.song-card audio'));

    function pauseAllExcept(target) {
        allAudios().forEach(a => {
            if (a !== target) {
                try { a.pause(); } catch {}
            }
        });
        // Reset other play buttons' labels
        document.querySelectorAll('.play-btn').forEach(b => {
            if (b !== currentBtn) b.textContent = '▶ Play';
        });
    }

    let currentBtn = null;

    playButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const card = btn.closest('.song-card');
            if (!card) return;
            const audio = card.querySelector('audio');
            if (!audio) return; // no preview available

            currentBtn = btn;
            if (audio.paused) {
                pauseAllExcept(audio);
                audio.play().then(() => {
                    btn.textContent = '⏸ Pause';
                }).catch(() => {
                    btn.textContent = '▶ Play';
                });
            } else {
                audio.pause();
                btn.textContent = '▶ Play';
            }
        });
    });

    // Reset button text when a preview ends
    allAudios().forEach(a => {
        a.addEventListener('ended', () => {
            document.querySelectorAll('.play-btn').forEach(b => { b.textContent = '▶ Play'; });
        });
    });
});
</script>


<style>
.song-card { 
    cursor: grab;
    background-color: #1a1a1a; /* Solid dark background */
    border: 1px solid #333;
}
.quick-kept-btn { background-color: var(--spotify-green); color: #fff; border: none; }
</style>
{% endblock %}
