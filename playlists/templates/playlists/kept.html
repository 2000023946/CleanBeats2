{% extends "base.html" %}
{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <h2>My Choices</h2>
            <button class="btn btn-outline-success" id="save-playlist-changes" {% if not removed %}disabled{% endif %}>
                <i class="bi bi-save"></i> Save Playlist Changes
            </button>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'playlists.edit_by_id' playlist_id=playlist_id %}?show_all=true">Reset Progress</a>
            <a class="btn btn-secondary" href="{% url 'playlists.edit_by_id' playlist_id=playlist_id %}">Back to Edit</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Saved</h4>
                <div class="btn-group btn-group-sm gap-1 rounded" role="group">
                    <button class="btn btn-outline-primary rounded" id="select-all-kept">Select All</button>
                    <button class="btn btn-danger rounded" id="move-kept-to-removed" disabled>Move to Removed</button>
                </div>
            </div>
            {% if kept %}
                <ul id="kept-list" class="list-group list-group-dark">
                {% for s in kept %}
                    <li class="list-group-item d-flex align-items-center kept-item" 
                        data-track-uri="{{ s.track_uri }}"
                        data-name="{{ s.name }}"
                        data-artists="{{ s.artists|join:', ' }}"
                        data-image="{{ s.image_url }}"
                        data-preview="{{ s.preview_url }}"
                        data-spotify="{{ s.spotify_url }}">
                        <input type="checkbox" class="form-check-input me-2 kept-checkbox" data-track-uri="{{ s.track_uri }}">
                        <img src="{{ s.image_url|default:'/static/img/placeholder.png' }}" alt="cover" style="width:56px; height:56px; object-fit:cover; margin-right:12px;"/>
                        <div>
                            <div class="fw-bold">{{ s.name }}</div>
                            <div class="text-muted small">{{ s.artists|join:', ' }}</div>
                        </div>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <a href="{{ s.spotify_url }}" class="btn btn-outline-spotify btn-sm btn-pill">Open</a>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No songs marked as kept yet.</p>
            {% endif %}
        </div>

        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Removed</h4>
                <div class="btn-group btn-group-sm gap-1 rounded" role="group">
                    <button class="btn btn-outline-primary rounded" id="select-all-removed">Select All</button>
                    <button class="btn btn-success rounded" id="move-removed-to-kept" disabled>Move to Kept</button>
                </div>
            </div>
            {% if removed %}
                <ul id="removed-list" class="list-group list-group-dark">
                {% for s in removed %}
                    <li class="list-group-item d-flex align-items-center removed-item" 
                        data-track-uri="{{ s.track_uri }}"
                        data-name="{{ s.name }}"
                        data-artists="{{ s.artists|join:', ' }}"
                        data-image="{{ s.image_url }}"
                        data-preview="{{ s.preview_url }}"
                        data-spotify="{{ s.spotify_url }}">
                        <input type="checkbox" class="form-check-input me-2 removed-checkbox" data-track-uri="{{ s.track_uri }}">
                        <img src="{{ s.image_url|default:'/static/img/placeholder.png' }}" alt="cover" style="width:56px; height:56px; object-fit:cover; margin-right:12px;"/>
                        <div>
                            <div class="fw-bold">{{ s.name }}</div>
                            <div class="text-muted small">{{ s.artists|join:', ' }}</div>
                        </div>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <a href="{{ s.spotify_url }}" class="btn btn-outline-spotify btn-sm btn-pill">Open</a>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No songs marked as removed yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Helper to read CSRF token from cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Select All functionality
    const selectAllKept = document.getElementById('select-all-kept');
    const selectAllRemoved = document.getElementById('select-all-removed');
    const moveKeptToRemoved = document.getElementById('move-kept-to-removed');
    const moveRemovedToKept = document.getElementById('move-removed-to-kept');

    function updateButtonStates() {
        const keptChecked = document.querySelectorAll('.kept-checkbox:checked').length;
        const removedChecked = document.querySelectorAll('.removed-checkbox:checked').length;
        
        moveKeptToRemoved.disabled = keptChecked === 0;
        moveRemovedToKept.disabled = removedChecked === 0;
    }

    // Select all kept songs
    if (selectAllKept) {
        selectAllKept.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.kept-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            selectAllKept.textContent = allChecked ? 'Select All' : 'Deselect All';
            updateButtonStates();
        });
    }

    // Select all removed songs
    if (selectAllRemoved) {
        selectAllRemoved.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.removed-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            selectAllRemoved.textContent = allChecked ? 'Select All' : 'Deselect All';
            updateButtonStates();
        });
    }

    // Update button states when checkboxes change
    document.addEventListener('change', (e) => {
        if (e.target.matches('.kept-checkbox') || e.target.matches('.removed-checkbox')) {
            updateButtonStates();
        }
    });

    // Move kept songs to removed
    if (moveKeptToRemoved) {
        moveKeptToRemoved.addEventListener('click', async () => {
            const checked = document.querySelectorAll('.kept-checkbox:checked');
            if (checked.length === 0) return;

            const trackUris = Array.from(checked).map(cb => cb.dataset.trackUri);
            await bulkMoveSongs(trackUris, false, checked);
        });
    }

    // Move removed songs to kept
    if (moveRemovedToKept) {
        moveRemovedToKept.addEventListener('click', async () => {
            const checked = document.querySelectorAll('.removed-checkbox:checked');
            if (checked.length === 0) return;

            const trackUris = Array.from(checked).map(cb => cb.dataset.trackUri);
            await bulkMoveSongs(trackUris, true, checked);
        });
    }

    async function bulkMoveSongs(trackUris, toKept, checkboxElements) {
        // Disable buttons during operation
        moveKeptToRemoved.disabled = true;
        moveRemovedToKept.disabled = true;

        try {
            // Update each song in the database
            for (const trackUri of trackUris) {
                const li = document.querySelector(`li[data-track-uri="${trackUri}"]`);
                const payload = {
                    playlist_id: '{{ playlist_id }}',
                    track_uri: trackUri,
                    name: li.dataset.name,
                    artists: li.dataset.artists ? li.dataset.artists.split(',').map(s => s.trim()) : [],
                    image_url: li.dataset.image,
                    preview_url: li.dataset.preview,
                    spotify_url: li.dataset.spotify,
                    kept: toKept
                };

                const resp = await fetch("{% url 'playlists.save_decision' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    throw new Error('Failed to update song');
                }
            }

            // Move songs in the UI
            checkboxElements.forEach(checkbox => {
                const li = checkbox.closest('li');
                const trackUri = checkbox.dataset.trackUri;
                
                if (toKept) {
                    // Move from removed to kept
                    li.classList.remove('removed-item');
                    li.classList.add('kept-item');
                    checkbox.classList.remove('removed-checkbox');
                    checkbox.classList.add('kept-checkbox');
                    checkbox.checked = false;
                    
                    const keptList = document.getElementById('kept-list');
                    if (keptList) {
                        keptList.appendChild(li);
                    } else {
                        // Create kept list if it doesn't exist
                        const keptCol = document.querySelectorAll('.row > .col-md-6')[0];
                        const placeholder = keptCol.querySelector('p.text-muted');
                        if (placeholder) placeholder.remove();
                        
                        const newKeptList = document.createElement('ul');
                        newKeptList.id = 'kept-list';
                        newKeptList.className = 'list-group list-group-dark';
                        newKeptList.appendChild(li);
                        keptCol.appendChild(newKeptList);
                    }
                } else {
                    // Move from kept to removed
                    li.classList.remove('kept-item');
                    li.classList.add('removed-item');
                    checkbox.classList.remove('kept-checkbox');
                    checkbox.classList.add('removed-checkbox');
                    checkbox.checked = false;
                    
                    const removedList = document.getElementById('removed-list');
                    if (removedList) {
                        removedList.appendChild(li);
                    } else {
                        // Create removed list if it doesn't exist
                        const removedCol = document.querySelectorAll('.row > .col-md-6')[1];
                        const placeholder = removedCol.querySelector('p.text-muted');
                        if (placeholder) placeholder.remove();
                        
                        const newRemovedList = document.createElement('ul');
                        newRemovedList.id = 'removed-list';
                        newRemovedList.className = 'list-group list-group-dark';
                        newRemovedList.appendChild(li);
                        removedCol.appendChild(newRemovedList);
                    }
                }
            });

            // Check if lists are empty and add placeholders
            const keptList = document.getElementById('kept-list');
            const removedList = document.getElementById('removed-list');
            
            if (keptList && keptList.children.length === 0) {
                const keptCol = document.querySelectorAll('.row > .col-md-6')[0];
                keptList.remove();
                const placeholder = document.createElement('p');
                placeholder.className = 'text-muted';
                placeholder.textContent = 'No songs marked as kept yet.';
                keptCol.appendChild(placeholder);
            }
            
            if (removedList && removedList.children.length === 0) {
                const removedCol = document.querySelectorAll('.row > .col-md-6')[1];
                removedList.remove();
                const placeholder = document.createElement('p');
                placeholder.className = 'text-muted';
                placeholder.textContent = 'No songs marked as removed yet.';
                removedCol.appendChild(placeholder);
            }

            // Update Save Playlist Changes button state
            updateSaveButtonState();

            // Reset select all buttons
            if (selectAllKept) selectAllKept.textContent = 'Select All';
            if (selectAllRemoved) selectAllRemoved.textContent = 'Select All';
            
        } catch (err) {
            console.error('Failed to move songs', err);
            alert('Failed to move songs. Please try again.');
        } finally {
            updateButtonStates();
        }
    }

    // Function to update Save Playlist Changes button state
    function updateSaveButtonState() {
        const savePlaylistBtn = document.getElementById('save-playlist-changes');
        if (savePlaylistBtn) {
            const removedList = document.getElementById('removed-list');
            const hasRemovedSongs = removedList && removedList.children.length > 0;
            savePlaylistBtn.disabled = !hasRemovedSongs;
        }
    }

    // Save Playlist Changes functionality
    const savePlaylistBtn = document.getElementById('save-playlist-changes');
    
    if (savePlaylistBtn) {
        savePlaylistBtn.addEventListener('click', async () => {
            const removedList = document.getElementById('removed-list');
            const removedCount = removedList ? removedList.children.length : 0;
            
            if (removedCount === 0) {
                alert('No songs to remove from the playlist.');
                return;
            }
            
            // Confirmation dialog
            const confirmMsg = `This will permanently remove ${removedCount} song${removedCount !== 1 ? 's' : ''} from your Spotify playlist. Continue?`;
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Disable all buttons and show loading state
            const originalText = savePlaylistBtn.innerHTML;
            savePlaylistBtn.disabled = true;
            savePlaylistBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
            
            moveKeptToRemoved.disabled = true;
            moveRemovedToKept.disabled = true;
            selectAllKept.disabled = true;
            selectAllRemoved.disabled = true;
            
            try {
                const resp = await fetch("{% url 'playlists.apply_changes' playlist_id=playlist_id %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                const data = await resp.json();
                
                if (data.status === 'success') {
                    // Show success message
                    alert(data.message);
                    
                    // Clear the removed section
                    if (removedList) {
                        removedList.remove();
                        
                        const removedCol = document.querySelectorAll('.row > .col-md-6')[1];
                        const placeholder = document.createElement('p');
                        placeholder.className = 'text-muted';
                        placeholder.textContent = 'No songs marked as removed yet.';
                        removedCol.appendChild(placeholder);
                    }
                    
                    // Disable the save button since there's nothing left to remove
                    savePlaylistBtn.disabled = true;
                    savePlaylistBtn.innerHTML = originalText;
                } else {
                    // Show error message
                    alert(data.message || 'Failed to update playlist. Please try again.');
                    
                    // Re-enable buttons
                    savePlaylistBtn.disabled = false;
                    savePlaylistBtn.innerHTML = originalText;
                    updateButtonStates();
                }
                
            } catch (err) {
                console.error('Failed to save playlist changes', err);
                alert('An error occurred while updating your playlist. Please try again.');
                
                // Re-enable buttons
                savePlaylistBtn.disabled = false;
                savePlaylistBtn.innerHTML = originalText;
            } finally {
                // Re-enable select buttons
                selectAllKept.disabled = false;
                selectAllRemoved.disabled = false;
                updateButtonStates();
            }
        });
    }
});
</script>
<style>
.form-check-input {
    cursor: pointer;
}
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}
</style>
{% endblock %}
