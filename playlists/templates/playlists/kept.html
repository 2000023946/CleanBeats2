{% extends "base.html" %}
{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Kept / Removed — Playlist</h2>
        <a class="btn btn-secondary" href="{% url 'playlists.edit_by_id' playlist_id=playlist_id %}">Back to Edit</a>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h4>Kept</h4>
            {% if kept %}
                <ul id="kept-list" class="list-group">
                {% for s in kept %}
                    <li class="list-group-item d-flex align-items-center kept-item" data-track-uri="{{ s.track_uri }}">
                        <img src="{{ s.image_url|default:'/static/img/placeholder.png' }}" alt="cover" style="width:56px; height:56px; object-fit:cover; margin-right:12px;"/>
                        <div>
                            <div class="fw-bold">{{ s.name }}</div>
                            <div class="text-muted small">{{ s.artists|join:', ' }}</div>
                        </div>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <a href="{{ s.spotify_url }}" class="btn btn-sm kept-action-btn">Open</a>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No songs marked as kept yet.</p>
            {% endif %}
        </div>

        <div class="col-md-6">
            <h4>Removed</h4>
            {% if removed %}
                <ul id="removed-list" class="list-group">
                {% for s in removed %}
                    <li class="list-group-item d-flex align-items-center removed-item" data-track-uri="{{ s.track_uri }}">
                        <img src="{{ s.image_url|default:'/static/img/placeholder.png' }}" alt="cover" style="width:56px; height:56px; object-fit:cover; margin-right:12px;"/>
                        <div>
                            <div class="fw-bold">{{ s.name }}</div>
                            <div class="text-muted small">{{ s.artists|join:', ' }}</div>
                        </div>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <a href="{{ s.spotify_url }}" class="btn btn-sm kept-action-btn">Open</a>
                            <button class="btn btn-sm kept-action-btn reconsider-btn" data-track-uri="{{ s.track_uri }}">Reconsider</button>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No songs marked as removed yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const removedList = document.getElementById('removed-list');
    let keptList = document.getElementById('kept-list');

    // helper to read CSRF token from cookie if template token not present
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // use event delegation on removed-list so dynamically moved items still work
    if (removedList) {
        removedList.addEventListener('click', async (ev) => {
            const btn = ev.target.closest('.reconsider-btn');
            if (!btn) return;

            ev.preventDefault();
            const li = btn.closest('.removed-item');
            const trackUri = btn.dataset.trackUri || btn.getAttribute('data-track-uri');
            const payload = { playlist_id: '{{ playlist_id }}', track_uri: trackUri };

            // disable button while in-flight
            btn.disabled = true;
            btn.textContent = 'Working...';

            try {
                const resp = await fetch("{% url 'playlists.reconsider_decision' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': ('{{ csrf_token }}' === '' ? getCookie('csrftoken') : '{{ csrf_token }}')
                    },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    console.error('reconsider failed', resp.status, data);
                    throw new Error('reconsider failed');
                }

                // remove DOM node from removed-list (song returns to unedited pool)
                if (li) {
                    const parentUl = li.parentNode;
                    li.remove();

                    // if removed list is empty now, show placeholder in removed column
                    if (parentUl && parentUl.children.length === 0) {
                        const removedCol = document.querySelectorAll('.row > .col-md-6')[1];
                        if (removedCol) {
                            parentUl.remove();
                            const placeholder = document.createElement('p');
                            placeholder.className = 'text-muted';
                            placeholder.textContent = 'No songs marked as removed yet.';
                            removedCol.appendChild(placeholder);
                        }
                    }
                }

                // Optionally show a small success indicator
                // alert('Song returned to unedited pool');

            } catch (err) {
                console.error('Failed to reconsider removed track', err);
                alert('Could not reconsider song — try again.');
                btn.disabled = false;
                btn.textContent = 'Reconsider';
            }
        });
    }
});
</script>
<style>
.kept-action-btn{background:#000;color:#fff;border:none}
.kept-action-btn:hover{opacity:0.9}
</style>
{% endblock %}
